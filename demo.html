<!-- Written by Claude 4.0 -->
<!-- Date: 2025-8-19 -->

<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Target Diarization Demo</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #2d3748;
            line-height: 1.6;
            padding: 20px;
        }
        
        .main-container {
            max-width: 1400px;
            margin: 0 auto;
        }
        
        .hero-section {
            text-align: center;
            /* padding: 60px 0; */
            margin-bottom: 40px;
        }
        
        .hero-title {
            font-size: 3.5rem;
            font-weight: 700;
            color: white;
            margin-bottom: 16px;
            text-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .hero-subtitle {
            font-size: 1.25rem;
            color: rgba(255,255,255,0.9);
            font-weight: 300;
            margin-bottom: 32px;
            max-width: 600px;
            margin-left: auto;
            margin-right: auto;
        }
        
        .container {
            background: rgba(255,255,255,0.95);
            backdrop-filter: blur(20px);
            border-radius: 24px;
            padding: 40px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            margin-bottom: 32px;
            border: 1px solid rgba(255,255,255,0.2);
        }
        
        .section-header {
            display: flex;
            align-items: center;
            margin-bottom: 32px;
        }
        
        .section-icon {
            font-size: 2rem;
            margin-right: 16px;
        }
        
        .section-title {
            font-size: 1.5rem;
            font-weight: 600;
            color: #1a202c;
            margin: 0;
        }
        
        .section-description {
            color: #718096;
            font-size: 0.95rem;
            margin-top: 4px;
        }
        
        .section {
            margin-bottom: 40px;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
            color: #555;
        }
        
        .form-input {
            width: 100%;
            padding: 16px 20px;
            border: 2px solid #e2e8f0;
            border-radius: 12px;
            font-size: 16px;
            font-family: inherit;
            transition: all 0.3s ease;
            background: white;
        }
        
        .form-input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
            transform: translateY(-1px);
        }
        
        input[type="file"],
        input[type="number"],
        input[type="text"],
        select {
            width: 100%;
            padding: 16px 20px;
            border: 2px solid #e2e8f0;
            border-radius: 12px;
            font-size: 16px;
            font-family: inherit;
            transition: all 0.3s ease;
            background: white;
        }
        
        input:focus, select:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
            transform: translateY(-1px);
        }
        
        .checkbox-group {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-top: 5px;
        }
        
        input[type="checkbox"] {
            width: auto;
            margin: 0;
        }
        
        .btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 14px 28px;
            border: none;
            border-radius: 12px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 500;
            margin: 8px;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
            position: relative;
            overflow: hidden;
        }
        
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.6);
        }
        
        .btn:active {
            transform: translateY(0);
        }
        
        .btn:disabled {
            background: #e2e8f0;
            color: #a0aec0;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        
        .btn-secondary {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            box-shadow: 0 4px 12px rgba(240, 147, 251, 0.4);
        }
        
        .btn-secondary:hover {
            box-shadow: 0 8px 25px rgba(240, 147, 251, 0.6);
        }
        
        button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 14px 28px;
            border: none;
            border-radius: 12px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 500;
            margin: 8px;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }
        
        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.6);
        }
        
        button:disabled {
            background: #e2e8f0;
            color: #a0aec0;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        
        .status-card {
            padding: 20px;
            border-radius: 16px;
            margin: 20px 0;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 12px;
            border: none;
            backdrop-filter: blur(10px);
        }
        
        .status {
            padding: 16px;
            border-radius: 16px;
            margin: 10px 0;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 12px;
            border: none;
            backdrop-filter: blur(10px);
        }
        
        .status.success {
            background: linear-gradient(135deg, rgba(72, 187, 120, 0.1) 0%, rgba(56, 178, 172, 0.1) 100%);
            color: #2f855a;
            border: 1px solid rgba(72, 187, 120, 0.2);
        }
        
        .status.error {
            background: linear-gradient(135deg, rgba(245, 101, 101, 0.1) 0%, rgba(229, 62, 62, 0.1) 100%);
            color: #c53030;
            border: 1px solid rgba(245, 101, 101, 0.2);
        }
        
        .status.info {
            background: linear-gradient(135deg, rgba(66, 153, 225, 0.1) 0%, rgba(102, 126, 234, 0.1) 100%);
            color: #3182ce;
            border: 1px solid rgba(66, 153, 225, 0.2);
        }
        
        .status.warning {
            background: linear-gradient(135deg, rgba(236, 201, 75, 0.1) 0%, rgba(245, 158, 11, 0.1) 100%);
            color: #d69e2e;
            border: 1px solid rgba(236, 201, 75, 0.2);
        }
        
        .result-container {
            background: rgba(255, 255, 255, 0.8);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: 20px;
            padding: 24px;
            margin-top: 24px;
            max-height: 600px;
            overflow-y: auto;
        }
        
        .result-item {
            background: rgba(255, 255, 255, 0.9);
            border: 1px solid rgba(226, 232, 240, 0.5);
            border-radius: 16px;
            padding: 20px;
            margin-bottom: 16px;
            transition: all 0.3s ease;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.04);
        }
        
        .result-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
        }
        
        .speaker-tag {
            display: inline-flex;
            align-items: center;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 13px;
            font-weight: 600;
            margin-right: 12px;
            letter-spacing: 0.5px;
            backdrop-filter: blur(10px);
        }
        
        .speaker-target {
            background: linear-gradient(135deg, #48bb78 0%, #38b2ac 100%);
            color: white;
            box-shadow: 0 4px 12px rgba(72, 187, 120, 0.3);
        }
        
        .speaker-other {
            background: linear-gradient(135deg, #718096 0%, #4a5568 100%);
            color: white;
            box-shadow: 0 4px 12px rgba(113, 128, 150, 0.3);
        }
        
        .speaker-uncertain {
            background: linear-gradient(135deg, #ecc94b 0%, #f6ad55 100%);
            color: #744210;
            box-shadow: 0 4px 12px rgba(236, 201, 75, 0.3);
        }
        
        .timerange {
            color: #6c757d;
            font-size: 14px;
            margin-bottom: 5px;
        }
        
        .text-content {
            color: #333;
            font-size: 16px;
            line-height: 1.4;
        }
        
        .statistics {
            background: #e9f7ef;
            border: 1px solid #27ae60;
            border-radius: 6px;
            padding: 15px;
            margin-top: 16px;
            margin-bottom: 16px;
        }
        
        .stat-item {
            display: inline-block;
            margin-right: 20px;
            font-weight: bold;
        }
        
        .ws-controls {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            align-items: center;
        }
        
        .audio-controls {
            /* margin: 20px 0; */
            /* padding: 15px; */
            background-color: #f8f9fa;
            border-radius: 6px;
        }
        
        pre {
            background-color: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 4px;
            padding: 15px;
            overflow-x: auto;
            font-size: 14px;
            white-space: pre-wrap;
        }
        
        .api-info {
            background: rgba(102, 126, 234, 0.1);
            border: 1px solid rgba(102, 126, 234, 0.2);
            border-radius: 16px;
            padding: 24px;
            margin-bottom: 24px;
            backdrop-filter: blur(10px);
        }
        
        .form-group {
            margin-bottom: 24px;
        }
        
        label {
            display: block;
            margin-bottom: 12px;
            font-weight: 600;
            color: #2d3748;
            font-size: 16px;
        }
        
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255,255,255,0.3);
            border-top: 3px solid #ffffff;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-right: 12px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* Toast æ ·å¼ - ç±»ä¼¼ Gradio å³ä¸Šè§’æç¤º */
        .toast-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 9999;
            pointer-events: none;
            max-width: 400px;
        }
        
        .toast {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            border-radius: 12px;
            padding: 16px 20px;
            margin-bottom: 12px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.12);
            border: 1px solid rgba(255, 255, 255, 0.2);
            display: flex;
            align-items: center;
            gap: 12px;
            transform: translateX(400px);
            opacity: 0;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            pointer-events: auto;
            position: relative;
            overflow: hidden;
        }
        
        .toast.show {
            transform: translateX(0);
            opacity: 1;
        }
        
        .toast::before {
            content: '';
            position: absolute;
            left: 0;
            top: 0;
            bottom: 0;
            width: 4px;
            border-radius: 2px 0 0 2px;
        }
        
        .toast.toast-success::before {
            background: linear-gradient(135deg, #48bb78 0%, #38b2ac 100%);
        }
        
        .toast.toast-error::before {
            background: linear-gradient(135deg, #f56565 0%, #e53e3e 100%);
        }
        
        .toast.toast-info::before {
            background: linear-gradient(135deg, #4299e1 0%, #667eea 100%);
        }
        
        .toast.toast-warning::before {
            background: linear-gradient(135deg, #ecc94b 0%, #f6ad55 100%);
        }
        
        .toast-icon {
            font-size: 18px;
            flex-shrink: 0;
        }
        
        .toast-success .toast-icon {
            color: #48bb78;
        }
        
        .toast-error .toast-icon {
            color: #f56565;
        }
        
        .toast-info .toast-icon {
            color: #4299e1;
        }
        
        .toast-warning .toast-icon {
            color: #ecc94b;
        }
        
        .toast-content {
            flex: 1;
            font-size: 14px;
            line-height: 1.4;
            color: #2d3748;
            font-weight: 500;
        }
        
        .toast-close {
            background: none;
            border: none;
            font-size: 16px;
            color: #a0aec0;
            cursor: pointer;
            padding: 0;
            margin: 0;
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: all 0.2s ease;
            flex-shrink: 0;
        }
        
        .toast-close:hover {
            background: rgba(160, 174, 192, 0.1);
            color: #718096;
        }
        
        @media (max-width: 768px) {
            .hero-title {
                font-size: 2.5rem;
            }
            
            .row {
                flex-direction: column;
            }
            
            .container {
                margin: 0 16px;
                padding: 24px;
            }
            
            .toast-container {
                top: 10px;
                right: 10px;
                left: 10px;
                max-width: none;
            }
            
            .toast {
                transform: translateY(-100px);
            }
            
            .toast.show {
                transform: translateY(0);
            }
        }
        
        .hidden {
            display: none;
        }
        
        .row {
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
        }
        
        .col {
            flex: 1;
            min-width: 300px;
        }
    </style>
</head>
<body>
    <div class="main-container">
        <!-- Hero Section -->
        <div class="hero-section">
            <h1 class="hero-title">Target Diarization Demo</h1>
            <p class="hero-subtitle">å¸¦ç›®æ ‡è¯†åˆ«çš„è¯´è¯äººæ—¥å¿—ç³»ç»Ÿ</p>
        </div>
        
        <!-- API Status -->
        <div class="container">
            <div class="section-header">
                <div class="section-icon">ğŸ”—</div>
                <div>
                    <div class="section-title">æœåŠ¡çŠ¶æ€</div>
                    <div class="section-description">å®æ—¶ç›‘æ§AIå¤„ç†æœåŠ¡è¿è¡ŒçŠ¶æ€</div>
                </div>
            </div>
            <div class="api-info">
                <div class="form-group">
                    <label for="server-url-input">æœåŠ¡åœ°å€:</label>
                    <input type="url" id="server-url-input" value="http://localhost:8000" class="form-input" placeholder="http://localhost:8000">
                </div>
                <p><strong>è¿è¡ŒçŠ¶æ€:</strong> <span id="api-status">æ£€æŸ¥ä¸­...</span></p>
                <button onclick="checkApiHealth()" class="btn">åˆ·æ–°çŠ¶æ€</button>
            </div>
        </div>

        <!-- HTTP API æµ‹è¯• -->
        <div class="container">
            <div class="section-header">
                <div class="section-icon">ğŸµ</div>
                <div>
                    <div class="section-title">éå®æ—¶éŸ³é¢‘å¤„ç†</div>
                    <div class="section-description">ä¸Šä¼ å®Œæ•´éŸ³é¢‘æ–‡ä»¶ï¼Œç”Ÿæˆè¯´è¯äººæ—¥å¿—ç»“æœ</div>
                </div>
            </div>
            <div class="section">
            <form id="http-form">
                <div class="row">
                    <div class="col">
                        <div class="form-group">
                            <label for="audio-file">å¾…æ£€æµ‹éŸ³é¢‘æ–‡ä»¶</label>
                            <input type="file" id="audio-file" accept=".wav,.mp3,.flac,.m4a,.ogg" required class="form-input">
                            <small style="color: #718096; margin-top: 8px; display: block;">æ”¯æŒ WAV, MP3, FLAC, M4A, OGG æ ¼å¼</small>
                        </div>
                        
                        <div class="form-group">
                            <label for="target-file">ç›®æ ‡è¯´è¯äººéŸ³é¢‘ (å¯é€‰)</label>
                            <input type="file" id="target-file" accept=".wav,.mp3,.flac,.m4a,.ogg" class="form-input">
                            <small style="color: #718096; margin-top: 8px; display: block;">æä¾›ç›®æ ‡è¯´è¯äººæ ·æœ¬ä»¥é”šå®šå…¶åœ¨å¾…æ£€æµ‹éŸ³é¢‘ä¸­å‡ºç°çš„ä½ç½®</small>
                        </div>
                    </div>
                    
                    <div class="col">
                    </div>
                </div>
                
                <button type="submit" id="http-submit" class="btn">
                    <span id="http-loading" class="loading hidden"></span>
                    å¼€å§‹å¤„ç†
                </button>
            </form>
            
            <div id="http-status"></div>
            <div id="http-results" class="result-container hidden"></div>
        </div>
    </div>

        <!-- WebSocket API æµ‹è¯• -->
        <div class="container">
            <div class="section-header">
                <div class="section-icon">ğŸ¤</div>
                <div>
                    <div class="section-title">å®æ—¶è¯­éŸ³å¤„ç†</div>
                    <div class="section-description">å®æ—¶å½•éŸ³å¹¶è¿›è¡Œè¯´è¯äººåˆ†ç¦»ï¼Œå³æ—¶æŸ¥çœ‹å¤„ç†ç»“æœ</div>
                </div>
            </div>
            <div class="section">
            <div class="row">
                <div class="col">
                    <div class="form-group">
                        <label for="ws-target-file">ç›®æ ‡è¯´è¯äººéŸ³é¢‘ (å¯é€‰)</label>
                        <input type="file" id="ws-target-file" accept=".wav,.mp3,.flac,.m4a,.ogg" class="form-input">
                        <small style="color: #718096; margin-top: 8px; display: block;">æä¾›ç›®æ ‡è¯´è¯äººæ ·æœ¬ä»¥é”šå®šå…¶åœ¨å¾…æ£€æµ‹éŸ³é¢‘ä¸­å‡ºç°çš„ä½ç½®</small>
                    </div>
                    

                </div>
                
                <div class="col">
                    <div id="recording-controls-panel" class="form-group hidden">
                        <label>å½•éŸ³æ§åˆ¶</label>
                        <div class="audio-controls">
                            <div id="recording-status" class="status info">å‡†å¤‡å½•éŸ³...</div>
                            <div id="recording-level">
                                <label>éŸ³é‡: </label>
                                <div style="display: inline-block; width: 200px; height: 10px; background: #ddd; border-radius: 5px; overflow: hidden;">
                                    <div id="volume-bar" style="height: 100%; background: #4CAF50; width: 0%; transition: width 0.1s;"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="ws-controls">
                <button onclick="startRecordingInference()" id="ws-start-recording" class="btn">å¼€å§‹å¤„ç†</button>
                <button onclick="stopRecordingInference()" id="ws-stop-recording" class="btn btn-secondary" disabled>åœæ­¢å¤„ç†</button>
            </div>
            
            <div id="ws-status"></div>
            <div id="ws-results" class="result-container hidden"></div>
        </div>
    </div>

        <!-- åŸå§‹å“åº”æŸ¥çœ‹ -->
        <div class="container">
            <div class="section-header">
                <div class="section-icon">ğŸ”</div>
                <div>
                    <div class="section-title">æŠ€æœ¯è¯¦æƒ…</div>
                    <div class="section-description">æŸ¥çœ‹APIè¿”å›çš„åŸå§‹æ•°æ®</div>
                </div>
            </div>
            <div class="section">
                <button onclick="toggleRawData()" class="btn">åˆ‡æ¢æ•°æ®æ˜¾ç¤º</button>
                <pre id="raw-data" class="hidden"></pre>
            </div>
        </div>
    </div>

    <!-- Toast å®¹å™¨ -->
    <div id="toast-container" class="toast-container"></div>

    <script>
        // å…¨å±€å˜é‡
        let websocket = null;
        let isStreaming = false;
        let audioContext = null;
        let mediaRecorder = null;
        let audioChunks = [];
        let microphone = null;
        let processor = null;
        let isRecording = false;
        let recordingStartTime = null;
        let volumeAnalyzer = null;
        let toastCount = 0;
        
        // è·å–åŠ¨æ€æœåŠ¡å™¨åœ°å€
        function getServerUrl() {
            const input = document.getElementById('server-url-input');
            let url = input.value.trim();
            
            // éªŒè¯URLæ ¼å¼
            if (!url) {
                url = 'http://localhost:8000';
                input.value = url;
            }
            
            // ç¡®ä¿ä»¥http://æˆ–https://å¼€å¤´
            if (!url.startsWith('http://') && !url.startsWith('https://')) {
                url = 'http://' + url;
                input.value = url;
            }
            
            // ç§»é™¤æœ«å°¾çš„æ–œæ 
            if (url.endsWith('/')) {
                url = url.slice(0, -1);
                input.value = url;
            }
            
            return url;
        }
        
        function getWebSocketUrl() {
            const serverUrl = getServerUrl();
            return serverUrl.replace(/^http/, 'ws');
        }
        
        // é¡µé¢åŠ è½½æ—¶æ£€æŸ¥APIçŠ¶æ€
        window.onload = function() {
            checkApiHealth();
            
            // ç›‘å¬æœåŠ¡åœ°å€è¾“å…¥å˜åŒ–
            const serverUrlInput = document.getElementById('server-url-input');
            serverUrlInput.addEventListener('blur', function() {
                // å½“ç”¨æˆ·è¾“å…¥å®Œæˆæ—¶è‡ªåŠ¨éªŒè¯URLæ ¼å¼
                getServerUrl();
            });
            
            serverUrlInput.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    // æŒ‰Enteré”®æ—¶æ£€æŸ¥æœåŠ¡å¥åº·çŠ¶æ€
                    checkApiHealth();
                }
            });
        };
        
        // æ£€æŸ¥APIå¥åº·çŠ¶æ€
        async function checkApiHealth() {
            const statusElement = document.getElementById('api-status');
            const serverUrl = getServerUrl();
            
            try {
                statusElement.innerHTML = '<span style="color: #4299e1; font-weight: 600;">æ£€æŸ¥ä¸­...</span>';
                
                const response = await fetch(`${serverUrl}/health`, {
                    timeout: 5000
                });
                const data = await response.json();
                
                if (data.status === 'healthy') {
                    statusElement.innerHTML = '<span style="color: #48bb78; font-weight: 600;">âœ… AIæœåŠ¡è¿è¡Œæ­£å¸¸</span>';
                    showToast('æœåŠ¡è¿æ¥æˆåŠŸ', 'success', 2000);
                } else {
                    statusElement.innerHTML = '<span style="color: #f6ad55; font-weight: 600;">âš ï¸ æœåŠ¡çŠ¶æ€å¼‚å¸¸</span>';
                    showToast('æœåŠ¡çŠ¶æ€å¼‚å¸¸', 'warning', 3000);
                }
            } catch (error) {
                statusElement.innerHTML = '<span style="color: #f56565; font-weight: 600;">âŒ æ— æ³•è¿æ¥æœåŠ¡</span>';
                showToast(`æ— æ³•è¿æ¥åˆ° ${serverUrl}`, 'error', 4000);
                console.error('Health check failed:', error);
            }
        }
        
        // HTTP API æµ‹è¯•
        document.getElementById('http-form').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const submitBtn = document.getElementById('http-submit');
            const loadingIcon = document.getElementById('http-loading');
            const statusDiv = document.getElementById('http-status');
            const resultsDiv = document.getElementById('http-results');
            
            // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
            submitBtn.disabled = true;
            loadingIcon.classList.remove('hidden');
            statusDiv.innerHTML = '<div class="status info">AIæ­£åœ¨åˆ†æéŸ³é¢‘å†…å®¹...</div>';
            resultsDiv.classList.add('hidden');
            
            try {
                const formData = new FormData();
                
                // æ·»åŠ æ–‡ä»¶
                const audioFile = document.getElementById('audio-file').files[0];
                const targetFile = document.getElementById('target-file').files[0];
                
                if (!audioFile) {
                    throw new Error('âš ï¸ è¯·å…ˆé€‰æ‹©è¦å¤„ç†çš„éŸ³é¢‘æ–‡ä»¶');
                }
                
                formData.append('audio_file', audioFile);
                if (targetFile) {
                    formData.append('target_file', targetFile);
                }
                
                // æ·»åŠ å‚æ•° (å¼ºåˆ¶å¯ç”¨ç›®æ ‡éŸ³é¢‘è¾“å‡º)
                formData.append('is_single', false);
                formData.append('output_target_audio', true);
                
                const startTime = Date.now();
                const serverUrl = getServerUrl();
                const response = await fetch(`${serverUrl}/diarization/infer`, {
                    method: 'POST',
                    body: formData
                });
                
                const result = await response.json();
                const endTime = Date.now();
                
                // æ˜¾ç¤ºåŸå§‹æ•°æ®
                document.getElementById('raw-data').textContent = JSON.stringify(result, null, 2);
                
                if (result.success) {
                    statusDiv.innerHTML = `<div class="status success">
                        AIå¤„ç†å®Œæˆï¼ç”¨æ—¶: ${((endTime - startTime) / 1000).toFixed(2)}ç§’
                    </div>`;
                    
                    displayHttpResults(result.data);
                } else {
                    statusDiv.innerHTML = `<div class="status error">
                        å¤„ç†å¤±è´¥: ${result.error}
                    </div>`;
                }
                
            } catch (error) {
                statusDiv.innerHTML = `<div class="status error">
                    è¯·æ±‚å¤±è´¥: ${error.message}
                </div>`;
                console.error('HTTP request failed:', error);
            } finally {
                submitBtn.disabled = false;
                loadingIcon.classList.add('hidden');
            }
        });
        
        // æ˜¾ç¤ºHTTPç»“æœ
        function displayHttpResults(data) {
            const resultsDiv = document.getElementById('http-results');
            
            let html = `
                <h3>æ¨ç†ç»“æœ</h3>
                <div class="statistics">
                    <div class="stat-item">ç›®æ ‡è¯´è¯äºº: ${data.target_speaker_id}</div>
                    <div class="stat-item">æ€»è¯´è¯äººæ•°: ${data.total_speakers}</div>
                    <div class="stat-item">æ€»æ—¶é•¿: ${data.statistics.total_duration}ç§’</div>
                    <div class="stat-item">ç›®æ ‡è¯´è¯äººæ—¶é•¿: ${data.statistics.target_speaker_duration}ç§’</div>
                </div>
                
                <h3>è¯´è¯å†…å®¹:</h3>
            `;
            
            data.results.forEach((result, index) => {
                const speakerClass = `speaker-${result.speaker_type}`;
                html += `
                    <div class="result-item">
                        <div class="timerange">${result.timerange[0]}s - ${result.timerange[1]}s</div>
                        <span class="speaker-tag ${speakerClass}">
                            è¯´è¯äºº ${result.speaker} (${result.speaker_type})
                        </span>
                        <span style="font-size: 12px; color: #6c757d;">[${result.type}]</span>
                        <div class="text-content">${result.text}</div>
                    </div>
                `;
            });
            
            if (data.target_audio_base64) {
                html += `
                    <h3>ç›®æ ‡è¯´è¯äººéŸ³é¢‘:</h3>
                    <div class="result-item">
                        <p>éŸ³é¢‘æ•°æ®å·²æå– (Base64ç¼–ç ï¼Œé•¿åº¦: ${data.target_audio_base64.length} å­—ç¬¦)</p>
                        <button onclick="playTargetAudio('${data.target_audio_base64}')">æ’­æ”¾éŸ³é¢‘</button>
                    </div>
                `;
            }
            
            resultsDiv.innerHTML = html;
            resultsDiv.classList.remove('hidden');
        }
        

        
        // å¤„ç†WebSocketæ¶ˆæ¯
        function handleWebSocketMessage(message) {
            const resultsDiv = document.getElementById('ws-results');
            
            console.log('WebSocket message:', message);
            
            switch (message.type) {
                case 'config_ack':
                    showToast('é…ç½®å·²ç¡®è®¤ï¼Œå¼€å§‹å¤„ç†éŸ³é¢‘', 'success', 3000);
                    break;
                    
                case 'segment_result':
                    displayStreamResult(message.data);
                    break;
                    
                case 'status':
                    if (message.message === 'processing') {
                        showToast('æ­£åœ¨å¤„ç†éŸ³é¢‘æµ...', 'info', 2000);
                    } else if (message.message === 'completed') {
                        showToast('æµå¼æ¨ç†å®Œæˆ', 'success', 4000);
                    }
                    break;
                    
                case 'error':
                    showToast(`é”™è¯¯: ${message.message}`, 'error', 6000);
                    break;
            }
            
            // æ›´æ–°åŸå§‹æ•°æ®æ˜¾ç¤º
            const rawData = document.getElementById('raw-data');
            rawData.textContent += JSON.stringify(message, null, 2) + '\n\n';
        }
        
        // æ˜¾ç¤ºæµå¼ç»“æœ
        function displayStreamResult(data) {
            const resultsDiv = document.getElementById('ws-results');
            const segment = data.segment;
            const speakerClass = `speaker-${segment.speaker_type}`;
            
            const resultHtml = `
                <div class="result-item">
                    <div class="timerange">${segment.timerange[0]}s - ${segment.timerange[1]}s</div>
                    <span class="speaker-tag ${speakerClass}">
                        è¯´è¯äºº ${segment.speaker} (${segment.speaker_type})
                    </span>
                    <span style="font-size: 12px; color: #6c757d;">[${segment.type}]</span>
                    <div class="text-content">${segment.text}</div>
                    <div style="font-size: 12px; color: #999; margin-top: 5px;">
                        ç´¯è®¡æ—¶é—´: ${data.cumulative_time}s | 
                        æ¥æ”¶æ—¶é—´: ${new Date(data.timestamp * 1000).toLocaleTimeString()}
                    </div>
                </div>
            `;
            
            resultsDiv.innerHTML += resultHtml;
            resultsDiv.scrollTop = resultsDiv.scrollHeight;
        }
        

        
        // å½•éŸ³ç»„ä»¶åˆå§‹åŒ–
        async function initRecording() {
            try {
                // è¯·æ±‚éº¦å…‹é£æƒé™
                const stream = await navigator.mediaDevices.getUserMedia({
                    audio: {
                        sampleRate: 16000,
                        channelCount: 1,
                        echoCancellation: true,
                        noiseSuppression: true
                    }
                });
                
                // åˆ›å»ºéŸ³é¢‘ä¸Šä¸‹æ–‡
                audioContext = new (window.AudioContext || window.webkitAudioContext)({
                    sampleRate: 16000
                });
                
                // åˆ›å»ºéŸ³é¢‘èŠ‚ç‚¹
                microphone = audioContext.createMediaStreamSource(stream);
                processor = audioContext.createScriptProcessor(4096, 1, 1);
                volumeAnalyzer = audioContext.createAnalyser();
                volumeAnalyzer.fftSize = 256;
                
                // è¿æ¥éŸ³é¢‘èŠ‚ç‚¹
                microphone.connect(volumeAnalyzer);
                microphone.connect(processor);
                processor.connect(audioContext.destination);
                
                // éŸ³é¢‘å¤„ç†å›è°ƒ
                processor.onaudioprocess = function(event) {
                    if (isRecording && websocket && websocket.readyState === WebSocket.OPEN) {
                        const inputBuffer = event.inputBuffer.getChannelData(0);
                        sendAudioChunk(inputBuffer);
                    }
                    
                    // æ›´æ–°éŸ³é‡æ˜¾ç¤º
                    updateVolumeLevel();
                };
                
                return true;
            } catch (error) {
                console.error('å½•éŸ³åˆå§‹åŒ–å¤±è´¥:', error);
                throw error;
            }
        }
        
        // æ›´æ–°éŸ³é‡æ˜¾ç¤º
        function updateVolumeLevel() {
            if (!volumeAnalyzer) return;
            
            const dataArray = new Uint8Array(volumeAnalyzer.frequencyBinCount);
            volumeAnalyzer.getByteFrequencyData(dataArray);
            
            // è®¡ç®—å¹³å‡éŸ³é‡
            let sum = 0;
            for (let i = 0; i < dataArray.length; i++) {
                sum += dataArray[i];
            }
            const averageVolume = sum / dataArray.length;
            
            // æ›´æ–°éŸ³é‡æ¡
            const volumeBar = document.getElementById('volume-bar');
            if (volumeBar) {
                const percentage = (averageVolume / 255) * 100;
                volumeBar.style.width = percentage + '%';
            }
        }
        
        // å‘é€éŸ³é¢‘å—
        let audioBuffer = [];
        const CHUNK_SIZE = 32000; // 2ç§’çš„éŸ³é¢‘æ•°æ®ï¼ˆ16kHzé‡‡æ ·ç‡ï¼‰
        
        function sendAudioChunk(inputData) {
            // ç´¯ç§¯éŸ³é¢‘æ•°æ®
            audioBuffer.push(...inputData);
            
            // å½“ç´¯ç§¯åˆ°2ç§’çš„æ•°æ®æ—¶å‘é€
            if (audioBuffer.length >= CHUNK_SIZE) {
                const chunk = audioBuffer.slice(0, CHUNK_SIZE);
                audioBuffer = audioBuffer.slice(CHUNK_SIZE);
                
                // è½¬æ¢ä¸º16ä½æ•´æ•°
                const int16Array = new Int16Array(chunk.length);
                for (let i = 0; i < chunk.length; i++) {
                    int16Array[i] = Math.max(-32768, Math.min(32767, chunk[i] * 32767));
                }
                
                // ç¼–ç ä¸ºbase64å‘é€
                const base64Data = btoa(String.fromCharCode(...new Uint8Array(int16Array.buffer)));
                
                if (websocket && websocket.readyState === WebSocket.OPEN) {
                    websocket.send(JSON.stringify({
                        type: "audio_chunk",
                        data: base64Data
                    }));
                }
            }
        }
        
        // å·¥å…·å‡½æ•°
        function fileToBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = () => {
                    const base64 = reader.result.split(',')[1];
                    resolve(base64);
                };
                reader.onerror = reject;
                reader.readAsDataURL(file);
            });
        }
        
        // Toast ç›¸å…³å‡½æ•°
        function showToast(message, type = 'info', duration = 5000) {
            const container = document.getElementById('toast-container');
            const toastId = `toast-${++toastCount}`;
            
            // é€‰æ‹©å›¾æ ‡
            let icon = 'ğŸ”µ';
            switch (type) {
                case 'success':
                    icon = 'âœ…';
                    break;
                case 'error':
                    icon = 'âŒ';
                    break;
                case 'warning':
                    icon = 'âš ï¸';
                    break;
                case 'info':
                default:
                    icon = 'â„¹ï¸';
                    break;
            }
            
            // åˆ›å»ºtoastå…ƒç´ 
            const toast = document.createElement('div');
            toast.id = toastId;
            toast.className = `toast toast-${type}`;
            toast.innerHTML = `
                <div class="toast-icon">${icon}</div>
                <div class="toast-content">${message}</div>
                <button class="toast-close" onclick="hideToast('${toastId}')">&times;</button>
            `;
            
            // æ·»åŠ åˆ°å®¹å™¨
            container.appendChild(toast);
            
            // è§¦å‘æ˜¾ç¤ºåŠ¨ç”»
            setTimeout(() => {
                toast.classList.add('show');
            }, 10);
            
            // è‡ªåŠ¨éšè—
            if (duration > 0) {
                setTimeout(() => {
                    hideToast(toastId);
                }, duration);
            }
            
            return toastId;
        }
        
        function hideToast(toastId) {
            const toast = document.getElementById(toastId);
            if (toast) {
                toast.classList.remove('show');
                setTimeout(() => {
                    if (toast.parentNode) {
                        toast.parentNode.removeChild(toast);
                    }
                }, 400);
            }
        }
        
        function clearAllToasts() {
            const container = document.getElementById('toast-container');
            const toasts = container.querySelectorAll('.toast');
            toasts.forEach(toast => {
                hideToast(toast.id);
            });
        }
        
        function toggleRawData() {
            const rawData = document.getElementById('raw-data');
            rawData.classList.toggle('hidden');
        }
        
        function playTargetAudio(base64Data) {
            try {
                // è§£ç Base64éŸ³é¢‘æ•°æ®
                const binaryString = atob(base64Data);
                const bytes = new Uint8Array(binaryString.length);
                for (let i = 0; i < binaryString.length; i++) {
                    bytes[i] = binaryString.charCodeAt(i);
                }
                
                // åˆ›å»ºéŸ³é¢‘ä¸Šä¸‹æ–‡
                const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                const int16Array = new Int16Array(bytes.buffer);
                const float32Array = new Float32Array(int16Array.length);
                
                // è½¬æ¢ä¸ºæµ®ç‚¹æ•°
                for (let i = 0; i < int16Array.length; i++) {
                    float32Array[i] = int16Array[i] / 32767.0;
                }
                
                // åˆ›å»ºéŸ³é¢‘ç¼“å†²åŒº
                const audioBuffer = audioContext.createBuffer(1, float32Array.length, 16000);
                audioBuffer.getChannelData(0).set(float32Array);
                
                // æ’­æ”¾éŸ³é¢‘
                const source = audioContext.createBufferSource();
                source.buffer = audioBuffer;
                source.connect(audioContext.destination);
                source.start();
                
                alert('å¼€å§‹æ’­æ”¾ç›®æ ‡è¯´è¯äººéŸ³é¢‘');
                
            } catch (error) {
                console.error('Play audio failed:', error);
                alert('æ’­æ”¾éŸ³é¢‘å¤±è´¥: ' + error.message);
            }
        }

        // å¼€å§‹å½•éŸ³æ¨ç†
        async function startRecordingInference() {
            const resultsDiv = document.getElementById('ws-results');
            const recordingStatus = document.getElementById('recording-status');
            const recordingControlsPanel = document.getElementById('recording-controls-panel');
            
            try {
                // æ¸…é™¤ä¹‹å‰çš„toast
                clearAllToasts();
                
                // 1. åˆå§‹åŒ–å½•éŸ³ç»„ä»¶
                showToast('æ­£åœ¨åˆå§‹åŒ–å½•éŸ³ç»„ä»¶...', 'info', 2000);
                await initRecording();
                
                // 2. è¿æ¥WebSocket
                showToast('æ­£åœ¨è¿æ¥ WebSocket...', 'info', 2000);
                const wsUrl = getWebSocketUrl();
                websocket = new WebSocket(`${wsUrl}/diarization/stream`);
                
                await new Promise((resolve, reject) => {
                    websocket.onopen = resolve;
                    websocket.onerror = reject;
                    setTimeout(reject, 5000); // 5ç§’è¶…æ—¶
                });
                
                // 3. å‘é€é…ç½®
                const config = {
                    type: "config",
                    data: {
                        sampling_rate: 16000,
                        is_single: false,
                        output_target_audio: false,
                        chunk_duration: 1.0,
                        has_target_file: document.getElementById('ws-target-file').files.length > 0
                    }
                };
                
                websocket.send(JSON.stringify(config));
                
                // 4. å‘é€ç›®æ ‡éŸ³é¢‘ï¼ˆå¦‚æœæœ‰ï¼‰
                const targetFile = document.getElementById('ws-target-file').files[0];
                if (targetFile) {
                    showToast('æ­£åœ¨ä¸Šä¼ ç›®æ ‡éŸ³é¢‘...', 'info', 2000);
                    const targetAudioBase64 = await fileToBase64(targetFile);
                    websocket.send(JSON.stringify({
                        type: "target_audio",
                        data: targetAudioBase64
                    }));
                }
                
                // 5. è®¾ç½®WebSocketæ¶ˆæ¯å¤„ç†
                websocket.onmessage = function(event) {
                    const message = JSON.parse(event.data);
                    handleWebSocketMessage(message);
                };
                
                websocket.onclose = function() {
                    showToast('WebSocket è¿æ¥å·²å…³é—­', 'warning', 4000);
                    stopRecordingInference();
                };
                
                websocket.onerror = function(error) {
                    showToast('WebSocket è¿æ¥é”™è¯¯', 'error', 5000);
                    console.error('WebSocket error:', error);
                    stopRecordingInference();
                };
                
                // 6. å¼€å§‹å½•éŸ³
                isRecording = true;
                recordingStartTime = Date.now();
                audioBuffer = []; // é‡ç½®éŸ³é¢‘ç¼“å†²åŒº
                
                // æ›´æ–°UIçŠ¶æ€
                document.getElementById('ws-start-recording').disabled = true;
                document.getElementById('ws-stop-recording').disabled = false;
                
                // æ˜¾ç¤ºå½•éŸ³æ§åˆ¶é¢æ¿å’Œç»“æœå®¹å™¨
                recordingControlsPanel.classList.remove('hidden');
                recordingStatus.innerHTML = 'æ­£åœ¨å½•éŸ³...';
                
                showToast('å¼€å§‹å®æ—¶æ¨ç†', 'success', 3000);
                
                // æ˜¾ç¤ºç»“æœå®¹å™¨ï¼ˆå¦‚æœæ˜¯ç¬¬ä¸€æ¬¡å¯åŠ¨ï¼‰
                if (resultsDiv.classList.contains('hidden')) {
                    resultsDiv.innerHTML = '<h3>å®æ—¶æ¨ç†ç»“æœ:</h3>';
                    resultsDiv.classList.remove('hidden');
                }
                
            } catch (error) {
                showToast(`å¯åŠ¨å¤±è´¥: ${error.message}`, 'error', 6000);
                console.error('Start recording inference failed:', error);
                stopRecordingInference();
            }
        }
        
        // åœæ­¢å½•éŸ³æ¨ç†
        function stopRecordingInference() {
            const recordingControlsPanel = document.getElementById('recording-controls-panel');
            
            try {
                // 1. åœæ­¢å½•éŸ³
                isRecording = false;
                
                // 2. å‘é€éŸ³é¢‘ç»“æŸä¿¡å·
                if (websocket && websocket.readyState === WebSocket.OPEN) {
                    websocket.send(JSON.stringify({
                        type: "audio_end"
                    }));
                }
                
                // 3. å…³é—­WebSocketè¿æ¥
                if (websocket) {
                    websocket.close();
                    websocket = null;
                }
                
                // 4. æ¸…ç†éŸ³é¢‘èµ„æº
                if (processor) {
                    processor.disconnect();
                    processor = null;
                }
                
                if (microphone) {
                    microphone.disconnect();
                    microphone = null;
                }
                
                if (audioContext) {
                    audioContext.close();
                    audioContext = null;
                }
                
                // 5. æ›´æ–°UIçŠ¶æ€
                document.getElementById('ws-start-recording').disabled = false;
                document.getElementById('ws-stop-recording').disabled = true;
                
                // éšè—å½•éŸ³æ§åˆ¶é¢æ¿
                recordingControlsPanel.classList.add('hidden');
                
                showToast('å·²åœæ­¢å½•éŸ³æ¨ç†', 'info', 3000);
                
            } catch (error) {
                console.error('Stop recording inference failed:', error);
                showToast(`åœæ­¢è¿‡ç¨‹ä¸­å‡ºé”™: ${error.message}`, 'error', 5000);
            }
        }
    </script>
</body>
</html>
